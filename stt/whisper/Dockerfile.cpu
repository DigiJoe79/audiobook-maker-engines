# =============================================================================
# Whisper STT Engine - CPU Docker Image (Multi-Platform)
# =============================================================================
# OpenAI Whisper for speech-to-text transcription (CPU-only)
# Supports: linux/amd64, linux/arm64 (Apple Silicon via Docker, Raspberry Pi, etc.)
# Models are downloaded on-demand to /app/external_models
# =============================================================================

FROM python:3.12-slim

# Prevent interactive prompts during package installation
ENV DEBIAN_FRONTEND=noninteractive

WORKDIR /app

# -----------------------------------------------------------------------------
# System Dependencies
# -----------------------------------------------------------------------------
# ffmpeg is required by whisper for audio processing
RUN apt-get update && apt-get install -y --no-install-recommends \
    ffmpeg \
    git \
    && rm -rf /var/lib/apt/lists/*

# -----------------------------------------------------------------------------
# Python Virtual Environment
# -----------------------------------------------------------------------------
RUN python -m venv /opt/venv
ENV PATH="/opt/venv/bin:$PATH"

# Upgrade pip
RUN pip install --no-cache-dir --upgrade pip setuptools wheel

# -----------------------------------------------------------------------------
# PyTorch CPU-Only
# -----------------------------------------------------------------------------
# CPU-only PyTorch for multi-platform support (amd64 + arm64)
RUN pip install --no-cache-dir \
    torch \
    torchaudio \
    --index-url https://download.pytorch.org/whl/cpu

# -----------------------------------------------------------------------------
# Application Dependencies
# -----------------------------------------------------------------------------
COPY stt/whisper/requirements.txt ./
# Remove torch/torchaudio from requirements (already installed above)
RUN grep -v "^torch" requirements.txt | grep -v "^torchaudio" > requirements_filtered.txt \
    && pip install --no-cache-dir -r requirements_filtered.txt \
    && rm requirements_filtered.txt

# -----------------------------------------------------------------------------
# Base Server Files
# -----------------------------------------------------------------------------
COPY base_server.py ./
COPY base_quality_server.py ./

# -----------------------------------------------------------------------------
# Engine Files
# -----------------------------------------------------------------------------
COPY stt/whisper/server.py ./
COPY stt/whisper/models.py ./
COPY stt/whisper/engine.yaml ./

# -----------------------------------------------------------------------------
# Entrypoint and Directories
# -----------------------------------------------------------------------------
COPY scripts/docker-entrypoint.sh ./
RUN chmod +x /app/docker-entrypoint.sh

# Create required directories for Model Management Standard
RUN mkdir -p /app/models /app/external_models /app/samples

# -----------------------------------------------------------------------------
# Runtime Configuration
# -----------------------------------------------------------------------------
ENV PYTHONUNBUFFERED=1
ENV PORT=8767

EXPOSE 8767

# Health check using httpx (installed via requirements.txt)
HEALTHCHECK --interval=30s --timeout=10s --start-period=60s --retries=3 \
    CMD python -c "import httpx; httpx.get('http://localhost:${PORT}/health')" || exit 1

ENTRYPOINT ["/app/docker-entrypoint.sh"]
CMD ["sh", "-c", "python server.py --port ${PORT:-8767} --host 0.0.0.0"]
